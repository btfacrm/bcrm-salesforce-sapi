<?xml version="1.0" encoding="UTF-8"?>
<mule 
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch"
	xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
	xmlns="http://www.mulesoft.org/schema/mule/core" 
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation=" 
		http://www.mulesoft.org/schema/mule/ee/core 
		http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
		http://www.mulesoft.org/schema/mule/core 
		http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/salesforce 
		http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
		http://www.mulesoft.org/schema/mule/batch 
		http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd">

    <flow name="endpoint-agencyregion">

        <flow-ref doc:name="initialize batch" name="initialize-batch"/>

        <flow-ref doc:name="get account ids" name="query-account"/>
        
        <choice doc:name="Choice" >
            <when expression='#[sizeOf(vars.listIds) == sizeOf(vars.originalPayload)]'>
                <ee:transform doc:name="build Salesforce payload for trust account" >
                    <ee:message >
                        <ee:set-payload ><![CDATA[%dw 2.0
                        output application/java
                        ---
                        vars.originalPayload map (item, index) -> {
                            'Id' : (vars.listIds filter ( $.account == item.account )).id[0],
                            'Agency_Code__c': if (!isEmpty(item.agencyCode)) item.agencyCode else "#N/A",
                            'Agency__c': if (!isEmpty(item.agencyDescription)) item.agencyDescription else "#N/A",
                            'Region_Code__c': if (!isEmpty(item.regionCode)) item.regionCode else "#N/A",
                            'Region__c': if (!isEmpty(item.regionDescription)) item.regionDescription else "#N/A",
                            'Tribe__r.Tribe_Code__c': if (!isEmpty(item.tribeCode)) item.tribeCode else "#N/A",
                            'Tribe_Code__c': if (!isEmpty(item.tribeCode)) item.tribeCode else "#N/A",
                            'Tribe_Description__c': if (!isEmpty(item.tribeDescription)) item.tribeDescription else "#N/A",
                            'Agency_Region_Tribe_Date_Time__c': item.date
                        }
                        ]]>
                        </ee:set-payload>
                        <!-- 'Tribe__r.Tribe_Code__c': if (!isEmpty(item.tribeCode)) item.tribeCode else "#N/A", -->
                    </ee:message>
                </ee:transform>
                
                <set-variable variableName="salesforceObject" value="Trust_Account__c" doc:name="Salesforce object" />
                <set-variable variableName="bulkOperation" value="update" doc:name="Salesforce object" />
        
                <flow-ref doc:name="run job" name="job-bulk"/>
            </when>
            <otherwise>
                <set-variable doc:name="status 404" variableName="httpStatus" value="#[404]"/>
                <set-variable doc:name="message error" variableName="message" value="${messages.batch-primaryidentifier-notpresent}"/>

                <ee:transform doc:name="find missingIds" >
                    <ee:variables >
                        <ee:set-variable variableName="missingIds"><![CDATA[%dw 2.0
                            output application/json

                            var totalMissing = sizeOf(vars.originalPayload) - sizeOf(vars.listIds)
                            var sourceId = vars.listIds.account
                            var inputId = vars.originalPayload.account
                            ---
                            {
                                total:          totalMissing,
                                inputRecords:   sizeOf(inputId),
                                sourceRecords:  sizeOf(sourceId),
                                keys:           (vars.originalPayload.account -- vars.listIds.account)
                            }
                        ]]>
                        </ee:set-variable>	
                    </ee:variables>
                </ee:transform>
                <logger level="DEBUG" category="app" message="#['Error, missing identifiers: ' ++ vars.missingIds.total as String]" />
            </otherwise>
        </choice>

        <flow-ref doc:name="service response" name="service-response"/>
        <error-handler ref="global-error-handler" />		
    </flow>
</mule>
